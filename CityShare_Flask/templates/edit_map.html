{% extends 'index.html' %}

{% block stylingblock %}
    <!-- Link to static/edit_map_stylesheet.css -->
    <link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='Stylesheets/edit_map_stylesheet.css') }}">
{% endblock %}

{% block scriptblock %}

    <!-- Font-Awesome plugin -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!-- JQuery Library plugin -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- Bootstrap Library plugin -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

    <!-- link to static/Scripts/edit_map_JavaScript.js
    <script src="{{ url_for('static',filename='Scripts/edit_map_JavaScript.js') }}"></script>
    -->

    <script>

        // a global variable to make the map available at all methods, this is needed
        var map = null;

        // An array to keep track of the map listeners used to draw the different category types
        // (point, area, road). these listeners should be removed every time the user change shape type, to enable
        // customized enviromenet.
        var listeners = [];

        // if another info window is open, and the user clicked on another marker, this variable is used to
        // enable the user to change context to the wished marker.
        var open_info_window = null;

        // a map to store te shapes by their id's
        var shapes = [];

        function clear_map_events() {
            // removing previous eventlisteners from map
            if (listeners.length > 0) {
                for (var i = 0; i < listeners.length; i++) {
                    google.maps.event.removeListener(listeners[i]);
                    listeners[i].remove();
                }
            }
        }

        var current_shape_id = null;
        function register_shape(shape) {
            data = Object.keys(shapes).length;

            if (shape["type"] == "POINT") {
                shapes[data] = shape;
                (shape["marker"]).setMap(map);
                (shape["infowindow"]).open(map, shape["marker"]);
                open_info_window = shape["infowindow"];
                map.setOptions({draggableCursor: undefined});
                $("#pac-card").hide();
                current_shape_id = data;
                $("input[name~='New_Marker']").prop('checked', false);
                clear_map_events();
            }
            else if (shape["type"] == "AREA" || shape["type"] == "ROAD" )
            {
                var road;
                if (shape["type"] == "AREA") {
                    road = new google.maps.Polygon({
                        path: shape["points_array"],
                        strokeColor: color,
                        strokeOpacity: 1,
                        strokeWeight: 7,
                        fillColor: color,
                        fillOpacity: 0.4,
                        clickable: false
                    });
                } else {
                    road = new google.maps.Polyline({
                        path: shape["points_array"],
                        strokeColor: color,
                        strokeOpacity: 1,
                        strokeWeight: 7,
                    });
                }
                road.setMap(map);
                shape["marker"].setMap(map);
                shape["infowindow"].open(map, shape["marker"]);
                shape["shape"] = road;
                open_info_window = shape["infowindow"];
                shapes[data] = shape;
                $("#pac-card").hide();
                current_shape_id = data;
                $("input[name~='New_Marker']").prop('checked', false);
                map.setOptions({draggableCursor: undefined});
                clear_map_events();
            }
            return;
        }
        function delete_shape(shape_id) {

            var descision = confirm("Er du sikker på at du vil slette dette kart objektet ?");
            if (descision == true) {
                shape_to_delete = shapes[shape_id];

                (shapes[shape_id]["infowindow"]).close();
                (shapes[shape_id]["marker"]).setMap(null);

                if (shapes[shape_id]["shape"] != undefined) {
                    shapes[shape_id]["shape"].setMap(null);
                }

                delete shapes[shape_id];
                current_shape_id = null;
                open_info_window = null;

                handle_outside_bounds_click();
                $("#pac-card").show();
            }
        }

        function ResetRespondoentFieldsAndShapes() {

            var descision = confirm("Er du sikker på at du vil slett person data ?");
            if (descision == true) {
                {% for question in questions %}
                    $("#question_{{ question.ID }}").val("");
                {% endfor %}

                for (var key in shapes) {
                    (shapes[key]["marker"]).setMap(null);
                    if (shapes[key]["type"] == "AREA" || shapes[key]["type"] == "ROAD") {
                        (shapes[key]["shape"]).setMap(null);
                    }
                }
                shapes = {};
                }
        }
        function SaveRespondoent() {
            var Respondoent = {};
            {% for question in questions %}
                answer_{{ question.ID }} = $("#question_{{ question.ID }}").val();
                Respondoent["{{ question.question }}"] = {
                    "ID": {{ question.ID }},
                    "answer": answer_{{ question.ID }}
                }
            {% endfor %}

            var Shapes = {};
            for (var key in shapes) {
                Shapes[key] = {
                    "type": shapes[key]["type"],
                    "category_ID": shapes[key]["category_ID"],
                    "creater": shapes[key]["shape_creater"],
                    "center": shapes[key]["center"],
                    "area_or_path": shapes[key]["area_or_path"],
                    "title": shapes[key]["title"],
                    "description": shapes[key]["description"],
                    "rating": shapes[key]["rating"]
                }
            }

            $.post("/RegisterRespondoent",
                    {
                        Respondoent: JSON.stringify(Respondoent),
                        Shapes: JSON.stringify(Shapes),
                        Map_id: {{ map.mapid }}
                    },
                    function (data, status) {
                        if (data == "Success") {
                            alert("Repondent Data er lagret !");
                            // clear the map, and clear the shapes array as well
                            for (var key in shapes) {
                                (shapes[key]["marker"]).setMap(null);
                                if (shapes[key]["type"] == "AREA" || shapes[key]["type"] == "ROAD") {
                                    (shapes[key]["shape"]).setMap(null);
                                }
                            }
                            shapes = {};
                            {% for question in questions %}
                                $("#question_{{ question.ID }}").val("");
                            {% endfor %}
                            return;
                        } else {
                            alert("Kan ikke lagre respondent data, sjekk internett forbindelse");
                            return;
                        }
                    });
        }

        var last_valid_center;
        var last_valid_zoom;
        function handle_outside_bounds_click() {
            if (open_info_window != null) {
                open_info_window.close();
                open_info_window = null;
            }
            if (map.getZoom() < {{ map.zoom }}+1) {
                map.fitBounds(new google.maps.LatLngBounds(northeastcorner, southwestcorner));
            }
        }
        function handle_on_close_info_window() {
            if (open_info_window != null) {
                open_info_window.close();
                open_info_window = null;
                $("#pac-card").show();
            }
            $("#pac-card").show();
        }
        function handle_marker_click(infowindow, marker) {
            for (var key in shapes) {
                if (shapes[key]["marker"] == marker) {
                    current_shape_id = key;
                }
            }

            if (open_info_window != null) {
                open_info_window.close();
            }
            $("#pac-card").hide();
            infowindow.open(map, marker);
            open_info_window = infowindow;

        }

        function getBoundsZoomLevel(bounds, mapDim) {
            var WORLD_DIM = { height: 256, width: 256 };
            var ZOOM_MAX = 21;

            function latRad(lat) {
                var sin = Math.sin(lat * Math.PI / 180);
                var radX2 = Math.log((1 + sin) / (1 - sin)) / 2;
                return Math.max(Math.min(radX2, Math.PI), -Math.PI) / 2;
            }

            function zoom(mapPx, worldPx, fraction) {
                return Math.floor(Math.log(mapPx / worldPx / fraction) / Math.LN2);
            }

            var ne = bounds.getNorthEast();
            var sw = bounds.getSouthWest();

            var latFraction = (latRad(ne.lat()) - latRad(sw.lat())) / Math.PI;

            var lngDiff = ne.lng() - sw.lng();
            var lngFraction = ((lngDiff < 0) ? (lngDiff + 360) : lngDiff) / 360;

            var latZoom = zoom(mapDim.height, WORLD_DIM.height, latFraction);
            var lngZoom = zoom(mapDim.width, WORLD_DIM.width, lngFraction);

            return Math.min(latZoom, lngZoom, ZOOM_MAX);
        }

        // function to compute the centroid
        function computeCentroid(pointsarray) {
            var number_of_points = pointsarray.length;
            var latitude = 0;
            var longtitude = 0;
            for (var i = 0; i < number_of_points; i++) {
                latitude += pointsarray[i].lat();
                longtitude += pointsarray[i].lng();
            }
            centroid = new google.maps.LatLng((latitude / number_of_points), (longtitude / number_of_points));
            return centroid;
        };

        // function to make a string out of the array of points
        function makestringfromarray(array) {
            string = ""
            for (var i = 0; i < array.length; i++) {
                treat_point = array[i].toString().replace("(","").replace(")","").replace(", "," ");
                string += ","+treat_point;
            }
            string = string.slice(1);
            return string;
        }

        // function to make an array of points out of a string of points
        function makearrayfromstring(str) {
            array = [];
            str = str.split(",");
            for (var i = 0; i < str.length; i++) {
                point = str[i].replace(" ",", ");
                point = point.split(", ")
                point = new google.maps.LatLng(parseFloat(point[0]),parseFloat(point[1]));
                array.push(point);
            }
            return array;
        }

        // function to initilize and load the map from google API map services
        var markers = [];
        var markerCluster;
        function initMap() {
            northeastcorner = new google.maps.LatLng({{ map.northeastcorner }});
            southwestcorner = new google.maps.LatLng({{ map.southwestcorner }});
            bounds = new google.maps.LatLngBounds(northeastcorner, southwestcorner);

            var $mapDiv = $('#Map');
            var mapDim = { height: $mapDiv.height(), width: $mapDiv.width() };
            calculated_zoom = getBoundsZoomLevel(bounds, mapDim);

            map = new google.maps.Map(document.getElementById('Map'), {
                center: computeCentroid([northeastcorner, southwestcorner]),
                zoom: {{ map.zoom }},
                gestureHandling: true, // true to turn on hand scroll or 'none'
                zoomControl: true,
                fullscreenControl: false,
                bounds: bounds,

                streetViewControlOptions: {
                    position: google.maps.ControlPosition.LEFT_CENTER
                },
                zoomControlOptions: {
                    position: google.maps.ControlPosition.LEFT_CENTER
                },
                mapTypeControlOptions: {
                    position: google.maps.ControlPosition.RIGHT_CENTER
                },
                fullscreenControl: false
            });

            last_valid_center = map.getCenter();
            last_valid_zoom = map.getZoom();

            var card = document.getElementById('pac-card');
            var input = document.getElementById('pac-input');
            map.controls[google.maps.ControlPosition.TOP_CENTER].push(card);

            var autocomplete = new google.maps.places.Autocomplete(input);

            // Bind the map's bounds (viewport) property to the autocomplete object,
            // so that the autocomplete requests use the current map bounds for the
            // bounds option in the request.
            autocomplete.bindTo('bounds', map);

            autocomplete.addListener('place_changed', function() {

                var place = autocomplete.getPlace();
                if (!place.geometry) {
                    // User entered the name of a Place that was not suggested and
                    // pressed the Enter key, or the Place Details request failed.
                    window.alert("No details available for input: '" + place.name + "'");
                    return;
                }

                // If the place has a geometry, then present it on a map.
                if (place.geometry.viewport) {
                    bounds = new google.maps.LatLngBounds(northeastcorner, southwestcorner);
                    if (bounds.contains(place.geometry.viewport.getNorthEast()) && bounds.contains(place.geometry.viewport.getSouthWest())) {
                        map.fitBounds(place.geometry.viewport);
                    } else {
                        alert("Stedet er ikke inkludert i karet!");
                    }
                } else {
                    map.setCenter(place.geometry.location);
                    map.setZoom(17);  // Why 17? Because it looks good.
                }

                var address = '';
                if (place.address_components) {
                    address = [
                        (place.address_components[0] && place.address_components[0].short_name || ''),
                        (place.address_components[1] && place.address_components[1].short_name || ''),
                        (place.address_components[2] && place.address_components[2].short_name || '')
                    ].join(' ');
                }

            });

            google.maps.event.addListener(map,'click',function(event) {
                if (open_info_window != null) {
                    open_info_window.close();
                    open_info_window = null;
                    $("#pac-card").show();
                    handle_outside_bounds_click()
                }
            });

            // event to keep the user inside the map bound, and prevent adding markers outside the target geo area
            google.maps.event.addListener(map,'drag',function () {
                northeast = map.getBounds().getNorthEast(); // LatLng of the north-east corner
                southwest = map.getBounds().getSouthWest(); // LatLng of the south-west corder

                south = southwest.lat();
                west = southwest.lng();

                north = northeast.lat();
                east = northeast.lng();

                fixed_south = southwestcorner.lat();
                fixed_west = southwestcorner.lng();

                fixed_north = northeastcorner.lat();
                fixed_east = northeastcorner.lng();

                if ((east > fixed_west) || (west < fixed_east) || (north > fixed_south) || (south < fixed_north)) {
                    map.setCenter(last_valid_center);
                    map.setZoom(last_valid_zoom);
                } else {
                    last_valid_center = map.getCenter();
                    last_valid_zoom = map.getZoom();
                }
            });


            google.maps.event.addListener(map,'bounds_changed',function () {
                if (map.getZoom() < {{ map.zoom }}-1) {
                    map.fitBounds(bounds);
                    map.setZoom({{ map.zoom }});
                }
            });

            lat_constant = Math.abs(northeastcorner.lat()-southwestcorner.lat());
            lng_constant = Math.abs(northeastcorner.lng()-southwestcorner.lng());
            var outerCoords = [
                {lat: northeastcorner.lat()+lat_constant, lng: southwestcorner.lng()-lng_constant}, // north west
                {lat: southwestcorner.lat()-lat_constant, lng: southwestcorner.lng()-lng_constant}, // south west
                {lat: southwestcorner.lat()-lat_constant, lng: northeastcorner.lng()+lng_constant}, // south east
                {lat: northeastcorner.lat()+lat_constant, lng: northeastcorner.lng()+lng_constant} // north east
            ];
            var innerCoords = [
                {lat: northeastcorner.lat(), lng: northeastcorner.lng()},  // north east
                {lat: southwestcorner.lat(), lng: northeastcorner.lng()}, // south east
                {lat: southwestcorner.lat(), lng: southwestcorner.lng()}, // south west
                {lat: northeastcorner.lat(), lng: southwestcorner.lng()}, // north west

            ];
            map.data.add({
                geometry: new google.maps.Data.Polygon([outerCoords, innerCoords])
            });
            map.data.setStyle(function(feature) {
              var color = 'white';
              if (feature.getProperty('isColorful')) {
                color = feature.getProperty('color');
              }
              return /** @type {google.maps.Data.StyleOptions} */({
                  fillColor: color,
                  fillOpacity: 1,
                  strokeColor: color,
                  strokeWeight: 2
              });
            });

        }


        var choice_panel_toggled;
        function auto_adjust_dimentions() {
            window_width = $(window).width();
            if (window_width > 800) {
                    $("#Map").css({"width":"70%","display":"inline-block"});
                    $("#ChoicePanel").css({"width":"30%","display":"inline-block"});
                    $("#pac-card").css("width","90%");
                    $("#show_map_btn").css("display","none");
                    choice_panel_toggled = false;
                }
            else {
                    $("#Map").css({"width":"100%","display":"inline-block"});
                    $("#ChoicePanel").css("width","100%");
                    $("#ChoicePanel").hide();
                    $("#pac-card").css("width","80%");
                    $("#show_map_btn").css({"width":"100%","display":"inline"});
                    choice_panel_toggled = true;
                }
        }
        $(document).ready(function () {

            $("#info_window").hide();

            // function to listen to the category type changing by the user,
            // and add the neccessary eventlistners to the map
            $("input[name~='New_Marker']").change(function (e) {
                var changed_to = $(this).val();
                var icon = $(this).siblings('img').attr('src'); // only used by shapes with type points
                var category_id = $(this).attr('id');

                if (changed_to == "Area" || changed_to == "Road") {
                    icon = "../static/Images/edit.png";
                    map.setOptions({ draggableCursor : "url("+icon+") 20 50, default" });
                    color = $(this).siblings('div').css('background-color');
                    var draw_mode = false;
                    var points_array = [];
                    var line = null;
                }

                clear_map_events();

                switch(changed_to) {

                    // case current mode is Point
                    case "Point":

                        map.setOptions({ draggableCursor : "url("+icon+") 20 50, default" });

                        var clicklistener = google.maps.event.addListener(map,'click',function(event) {

                            handle_on_close_info_window();

                            if (event.latLng.lat() < southwestcorner.lat() && event.latLng.lat() > northeastcorner.lat()
                            && event.latLng.lng() < southwestcorner.lng() && event.latLng.lng() > northeastcorner.lng()) {

                                var marker = new google.maps.Marker({
                                    position: event.latLng,
                                    icon: icon,
                                    animation: google.maps.Animation.DROP
                                });
                                var content_window = $('#info_window').html();
                                var infowindow = new google.maps.InfoWindow({
                                    content: content_window
                                });

                                var new_point = {
                                    "type": "POINT",
                                    "marker": marker,
                                    "infowindow": infowindow,
                                    "category_ID": category_id,
                                    "center": marker.getPosition().toString(),
                                    "area_or_path": "",
                                    "title": "",
                                    "description": "",
                                    "rating": $("input[name~='rating']").val()
                                };

                                register_shape(new_point);


                                google.maps.event.addListener(marker, 'click', function (event) {
                                    handle_marker_click(infowindow, marker);
                                });

                                google.maps.event.addListener(infowindow, 'closeclick', function () {
                                    handle_outside_bounds_click();
                                    handle_on_close_info_window();
                                });

                                google.maps.event.addListener(infowindow, 'domready', function () {
                                    $("input[name~='title'], textarea[name~='description'], input[name~='rating']").off('blur change');
                                    $("input[name~='title'], textarea[name~='description'], input[name~='rating']").on('blur change', function () {
                                        for (var key in shapes) {
                                            if (shapes[key]["marker"] == marker) {
                                                shapes[key]['title'] = $("input[name~='title']").val();
                                                shapes[key]['description'] = $("textarea[name~='description']").val();
                                                shapes[key]['rating'] = $("input[name~='rating']").val();
                                            }
                                        }
                                    });

                                    $("#delete_btn").off('click');
                                    $("#delete_btn").on('click', function() {
                                        for (var key in shapes) {
                                            if (shapes[key]["marker"] == marker) {
                                                delete_shape(key);
                                            }
                                        }
                                    });
                                });

                            } else {
                                handle_outside_bounds_click();
                            }


                        });

                        listeners.push(clicklistener);

                        break;

                    // case current mode is Road
                    case "Road":

                        click_listener = google.maps.event.addListener(map,'click',function(event) {

                                handle_on_close_info_window();

                                cursor = new google.maps.Marker({
                                    position: event.latLng,
                                    icon: "../static/Images/edit.png",
                                    draggable: true
                                });
                                cursor.setMap(map);
                                map.setOptions({ draggableCursor : undefined});

                                if (draw_mode == false) {
                                    draw_mode = true;

                                    drag_listener = google.maps.event.addListener(cursor,'drag',function(event) {
                                        if (event.latLng.lat() < southwestcorner.lat() && event.latLng.lat() > northeastcorner.lat()
                                            && event.latLng.lng() < southwestcorner.lng() && event.latLng.lng() > northeastcorner.lng()) {
                                            var new_location = event.latLng;
                                            points_array.push(new_location);

                                            if (line != null) line.setMap(null);
                                            var Road = new google.maps.Polyline({
                                                path: points_array,
                                                strokeColor: color,
                                                strokeOpacity: 1,
                                                strokeWeight: 7
                                            });
                                            line = Road;
                                            line.setMap(map);
                                        }
                                    });

                                    var end = google.maps.event.addListener(cursor,'dragend',function(event) {
                                                var marker = new google.maps.Marker({
                                                    position: points_array[Math.round(points_array.length/2)]
                                                });

                                                var content_window = $('#info_window').html();
                                                var infowindow = new google.maps.InfoWindow({
                                                    content: content_window
                                                });

                                                new_road = {
                                                            "marker": marker,
                                                            "type": "ROAD",
                                                            "infowindow": infowindow,
                                                            "center": (points_array[Math.round(points_array.length/2)]).toString(),
                                                            "title": "",
                                                            "description": "",
                                                            "rating": "2",
                                                            "category_ID": (category_id).toString(),
                                                            "area_or_path": makestringfromarray(points_array),
                                                            "points_array": points_array
                                                        };

                                                register_shape(new_road);

                                                line.setMap(null);
                                                points_array = [];

                                                google.maps.event.addListener(marker, 'click', function (event) {
                                                            handle_marker_click(infowindow, marker)
                                                        });

                                                google.maps.event.addListener(infowindow, 'closeclick', function () {
                                                    handle_outside_bounds_click();
                                                    handle_on_close_info_window();
                                                });

                                                google.maps.event.addListener(infowindow, 'domready', function () {
                                                            $("input[name~='title'], textarea[name~='description'], input[name~='rating']").off('blur change');
                                                            $("input[name~='title'], textarea[name~='description'], input[name~='rating']").on('blur change', function () {
                                                                for (var key in shapes) {
                                                                    if (shapes[key]["marker"] == marker) {
                                                                        shapes[key]['title'] = $("input[name~='title']").val();
                                                                        shapes[key]['description'] = $("textarea[name~='description']").val();
                                                                        shapes[key]['rating'] = $("input[name~='rating']").val();
                                                                    }
                                                                }
                                                            });

                                                            $("#delete_btn").off('click');
                                                            $("#delete_btn").on('click', function() {
                                                                for (var key in shapes) {
                                                                    if (shapes[key]["marker"] == marker) {
                                                                        delete_shape(key);
                                                                    }
                                                                }
                                                            });
                                                        });


                                                draw_mode = false;
                                                cursor.setMap(null);
                                            });

                                    listeners.push(end);
                                    listeners.push(drag_listener);

                                }
                            });


                        listeners.push(click_listener);
                        break;

                    // case current mode is Area
                    case "Area":
                        click_listener = google.maps.event.addListener(map,'click',function(event) {

                                handle_on_close_info_window();

                                cursor = new google.maps.Marker({
                                    position: event.latLng,
                                    icon: "../static/Images/edit.png",
                                    draggable: true
                                });
                                cursor.setMap(map);
                                map.setOptions({ draggableCursor : undefined});

                                if (draw_mode == false) {
                                    draw_mode = true;

                                    drag_listener = google.maps.event.addListener(cursor,'drag',function(event) {
                                        if (event.latLng.lat() < southwestcorner.lat() && event.latLng.lat() > northeastcorner.lat()
                                        && event.latLng.lng() < southwestcorner.lng() && event.latLng.lng() > northeastcorner.lng()) {
                                            var new_location = event.latLng;
                                            points_array.push(new_location);

                                            if (line != null) line.setMap(null);
                                            var Road = new google.maps.Polyline({
                                                path: points_array,
                                                strokeColor: color,
                                                strokeOpacity: 1,
                                                strokeWeight: 7
                                            });
                                            line = Road;
                                            line.setMap(map);
                                        }
                                    });

                                    var end = google.maps.event.addListener(cursor,'dragend',function(event) {
                                        var marker = new google.maps.Marker({
                                                    position: computeCentroid(points_array)
                                                });

                                        var content_window = $('#info_window').html();
                                        var infowindow = new google.maps.InfoWindow({
                                                    content: content_window
                                                });

                                        new_road = {
                                                    "marker": marker,
                                                    "type": "AREA",
                                                    "infowindow": infowindow,
                                                    "center": (points_array[Math.round(points_array.length / 2)]).toString(),
                                                    "title": "",
                                                    "description": "",
                                                    "rating": "2",
                                                    "category_ID": (category_id).toString(),
                                                    "area_or_path": makestringfromarray(points_array),
                                                    "points_array": points_array
                                                };

                                        register_shape(new_road);

                                        line.setMap(null);
                                        points_array = [];

                                        google.maps.event.addListener(marker, 'click', function (event) {
                                                    handle_marker_click(infowindow, marker);
                                                });

                                        google.maps.event.addListener(infowindow, 'closeclick', function () {
                                            handle_outside_bounds_click();
                                            handle_on_close_info_window();
                                        });

                                        google.maps.event.addListener(infowindow, 'domready', function () {
                                                    $("input[name~='title'], textarea[name~='description'], input[name~='rating']").off('blur change');
                                                    $("input[name~='title'], textarea[name~='description'], input[name~='rating']").on('blur change', function () {
                                                        for (var key in shapes) {
                                                            if (shapes[key]["marker"] == marker) {
                                                                shapes[key]['title'] = $("input[name~='title']").val();
                                                                shapes[key]['description'] = $("textarea[name~='description']").val();
                                                                shapes[key]['rating'] = $("input[name~='rating']").val();
                                                            }
                                                        }
                                                    });

                                                    $("#delete_btn").off('click');
                                                    $("#delete_btn").on('click', function () {
                                                        for (var key in shapes) {
                                                            if (shapes[key]["marker"] == marker) {
                                                                delete_shape(key);
                                                            }
                                                        }
                                                    });
                                                });


                                        draw_mode = false;
                                        cursor.setMap(null);

                                    });

                                    listeners.push(end);
                                    listeners.push(drag_listener);

                                }

                            });

                        listeners.push(click_listener);

                        break;

                    // a deafult , not realy used. just in case
                    default:
                        break;
                }

            });

            // trigger for varying the lines/path width
            $("input[name~='Weight']").change(function (e) {

                for (var key in shapes) {
                    if (shapes[key]['type'] == "ROAD") {
                        shape = shapes[key]['shape'];
                        shape.setMap(null);
                        shape.strokeWeight = $("input[name~='Weight']").val();
                        shape.setMap(map);
                    }
                }
            });

            // trigger for varying the area opacity
            $("input[name~='Opacity']").change(function (e) {

                for (var key in shapes) {
                    if (shapes[key]['type'] == "AREA") {
                        shape = shapes[key]['shape'];
                        shape.setMap(null);
                        shape.strokeOpacity = ($("input[name~='Opacity']").val()/10);
                        shape.fillOpacity = ($("input[name~='Opacity']").val()/10);
                        shape.setMap(map);
                    }
                }

            });

            // code for adjusting dimentions on big and small screen devices
            auto_adjust_dimentions();
            $(window).resize(function () {
                auto_adjust_dimentions();
            });
            $("#toggle_panel").click(function () {

                window_width = $(window).width();
                if (window_width > 800) {
                    if(choice_panel_toggled) {
                        $("#Map").css({"width":"70%","display":"inline-block"});
                        $("#ChoicePanel").toggle();
                    } else {
                        $("#Map").css({"width":"100%","display":"inline-block"});
                        $("#ChoicePanel").toggle();
                    }
                } else {
                    $("#ChoicePanel").toggle();
                    $("#Map").toggle();
                }

                if(choice_panel_toggled) {
                    choice_panel_toggled = false;
                } else {
                    choice_panel_toggled = true;
                }


            });
            $("#show_map_btn").click(function () {
                auto_adjust_dimentions();
            });

            $("#clustring_switch").change(function () {
                /*
                selected_users = $("#filter_users").val();
                if (selected_users == null) selected_users = [];
                shapes_by_users = get_shapes_by_users(selected_users);
                */

                if ($("#clustring_switch").is(":checked") == true) {

                    var labels = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                    markers = [];

                    for (var key in shapes) {
                        if (shapes[key]["type"] == "POINT") {
                            markers.push(shapes[key]["marker"]);
                        }
                    }

                    // Add a marker clusterer to manage the markers.
                    markerCluster = new MarkerClusterer(map, markers,
                        {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'
                        });

                } else {
                    // kode to remove marker clustring
                    for (var i=0;i<markers.length;i++) {
                        markerCluster.removeMarker(markers[i]);
                    }

                    for (var key in shapes){
                        shapes[key]["marker"].setMap(map);
                        if (shapes[key]["type"] == "AREA" || shapes[key]["type"] == "ROAD") {
                           shapes[key]["shape"].setMap(map);
                       }
                    }

                }
            });

        });


    </script>

{% endblock %}

{% block content %}

    <!-- Choice panel to the left of the map or hidden/shown on small width devices -->
    <div id="ChoicePanel" class="part">
        <div class="panel-group" id="accordion">

            <div>
                <button type="button" id="show_map_btn" class="btn btn-warning" style="width: 100%">Back to Map</button>
            </div>

            <br>

            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h4 class="panel-title">
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapse1">
                            <strong>Kontrollpanel</strong></a>
                    </h4>
                </div>
                <div id="collapse1" class="panel-collapse collapse in">
                    <div class="panel-body">

                        <div class="slidecontainer">
                            <label for="Weight">Linjevekt</label>
                            <input type="range" name="Weight" min="1" max="10" value="5" class="slider" id="Weight">
                        </div>

                        <br>

                        <div class="slidecontainer">
                            <label for="Opacity">Området Opasitet/Synlighet</label>
                            <input type="range" name="Opacity" min="1" max="10" value="5" class="slider" id="Opacity">
                        </div>

                        <br>

                        <div class="slidecontainer">
                            <h4>Clustring/Gruppering av Markører <br> <code>(kun for punkt/kategorier)</code>: </h4>
                            <label class="switch">
                              <input id="clustring_switch" type="checkbox" hidden>
                              <span class="slider_clustring round"></span>
                            </label>
                        </div>

                    </div>
                </div>
            </div>

            <div class="panel panel-warning">
                <div class="panel-heading">
                    <h4 class="panel-title">
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapse2">
                            <strong>Ny Respondoent</strong></a>
                    </h4>
                </div>
                <div id="collapse2" class="panel-collapse collapse">
                    <div class="panel-body">
                        <div style="padding: 5%; margin: 5%; border-radius: 5px; border: 1px solid red">
                            <form>

                            {% for question in questions %}
                                <div class="form-group">
                                    <label for="pwd">{{ question.question }}</label>
                                    <input type="text" class="form-control" id="question_{{ question.ID }}" placeholder="Svar her" name="question.{{ question.ID }}">
                                </div>
                            {% endfor %}

                                <div class="form-group">
                                   <div class="btn-group btn-group-justified">
                                       <a onclick="SaveRespondoent();" class="btn btn-success">Lagre</a>
                                       <a type="button" class="btn btn-info" data-toggle="modal" data-target="#ShapeModal" data-backdrop="false">
                                           Ny Markør
                                       </a>
                                       <a onclick="ResetRespondoentFieldsAndShapes();" class="btn btn-danger">Slett</a>
                                   </div>
                                </div>

                                <div class="modal fade" id="ShapeModal" role="dialog">
                                    <div class="modal-dialog">

                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                                <h4 class="modal-title">Legg til En Markør</h4>
                                            </div>

                                            <div class="modal-body">

                                            <strong>Punkter</strong>
                                            {% for point_cat in points_categories %}
                                                <div class="radio">
                                                    <label>
                                                        <input type="radio" name="New_Marker" id="{{ point_cat.ID }}" value="Point">
                                                        <img class="category_icon" src="../static/icons/{{ point_cat.image_or_color }}">
                                                        <p>{{ point_cat.name }}</p>
                                                    </label>
                                                </div>
                                            {% endfor %}

                                            <strong>Linjer</strong>
                                            {% for road_cat in roads_categories %}
                                                <div class="radio">
                                                    <label>
                                                        <input type="radio" name="New_Marker" id="{{ road_cat.ID }}" value="Road">
                                                        <div class="color_box" style="background-color: {{ road_cat.image_or_color }}"></div>
                                                        <p>{{ road_cat.name }}</p>
                                                    </label>
                                                </div>
                                            {% endfor %}

                                            <strong>Områder</strong>
                                            {% for area_cat in areas_categories %}
                                                <div class="radio">
                                                    <label>
                                                        <input type="radio" name="New_Marker" id="{{ area_cat.ID }}" value="Area">
                                                        <div class="color_box" style="background-color: {{ area_cat.image_or_color }}"></div>
                                                        <p>{{ area_cat.name }}</p>
                                                    </label>
                                                </div>
                                            {% endfor %}

                                        </div>
                                        <div class="modal-footer">
                                          <button type="button" class="btn btn-default" data-dismiss="modal">Lukk</button>
                                        </div>
                                      </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <!-- Address Search Bar on map -->
    <div class="pac-card" id="pac-card">
        <div id="pac-container" class="input-group" style="margin-bottom: 0;">
            <span id="toggle_panel" class="input-group-addon" style="background-color: #ffffff"><i class="fa fa-cog" style="width: 24px; color: #2a62bc"></i></span>
            <input id="pac-input" class="form-control" type="text" placeholder="Søk her">
        </div>
    </div>

    <!-- a div to hold the map -->
    <div id="Map" class="part"></div>

    <!-- Info_Window on map -->
    <div id="info_window">
        <input type="hidden" name="position" value="">
        <div class='form-group'>
            <label for='title'>Titel:</label>
            <input type='title' class='form-control' id='title' placeholder='Titel' name='title' required>
        </div>
        <div class='form-group'>
            <label for='description'>Beskrivelse:</label>
            <textarea name='description' class='form-control' rows='2' id='description' placeholder='Beskrivelse' required></textarea>
        </div>
        <div class='slidecontainer'>
            <p>Din Vurdering: <span id='currentRating'></span></p>
            <input name='rating' type='range' min='1' max='5' value='2' class='slider' id='rating' required>
        </div>
        <br>
        <button type="button" id="delete_btn" class="btn btn-danger">Slett</button>
    </div>

    <!-- Link to download the map from google API services -->
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyACs8v_iZ7Y9-XS3KmTOL_JHvYGkmddERY&libraries=places&callback=initMap">
    </script>
    <!-- Link to include google clustering Library -->
    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">
    </script>

{% endblock %}